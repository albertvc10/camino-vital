# Reglas de Desarrollo - Camino Vital

## üéØ Contexto del Proyecto

**Proyecto:** Sistema automatizado de programa de ejercicio personalizado por email
**Stack:** n8n + PostgreSQL + Brevo + Stripe
**Audiencia:** Miles de seguidores de Instagram (alto potencial de usuarios)
**Estado:** MVP en producci√≥n con usuarios reales

---

## üèóÔ∏è Arquitectura de Entornos

### Entorno LOCAL (Desarrollo)
- **Ubicaci√≥n:** `~/Documents/HV_n8n/`
- **n8n:** http://localhost:5678
- **PostgreSQL:** localhost:5432 (contenedor `n8n_postgres`)
- **Prop√≥sito:** Desarrollo de workflows de Instagram + pruebas de Camino Vital
- **Docker Compose:** `docker-compose.yml` (YA EXISTE Y FUNCIONA)
- **Credenciales:** Usuario `admin`, password en `.env`
- **Base de datos:** `n8n` (PostgreSQL)

**IMPORTANTE:** Este n8n local ya est√° en uso para workflows de Instagram.
Para probar workflows de Camino Vital debes:
1. Crear schema separado `camino_vital` en la misma DB
2. Duplicar workflows con prefijo `[TEST-CV]`
3. NO interferir con workflows de Instagram existentes

**Setup inicial (primera vez):**
```bash
cd ~/Documents/HV_n8n/programa-camino-vital
./setup-local.sh
```
Este script:
- ‚úÖ Crea schema `camino_vital` en PostgreSQL local
- ‚úÖ Crea todas las tablas necesarias
- ‚úÖ Inserta datos de prueba (3 usuarios + contenido)
- ‚úÖ NO afecta workflows de Instagram existentes

### Entorno PRODUCCI√ìN (Digital Ocean)
- **Servidor:** 167.71.51.148
- **n8n:** https://n8n.habitos-vitales.com
- **Landing:** https://camino-vital.habitos-vitales.com
- **PostgreSQL:** postgres:5432 (Docker interno)
- **Prop√≥sito:** Sistema en vivo con usuarios reales
- **Base de datos:** M√∫ltiples schemas (Instagram + Camino Vital)

---

## ‚ö†Ô∏è REGLAS CR√çTICAS - NUNCA ROMPER

### üö´ PROHIBIDO en Producci√≥n Directamente

1. **NO modificar workflows activos sin probar en local primero**
   - Riesgo: Usuarios dejan de recibir emails
   - Consecuencia: P√©rdida de confianza, churning

2. **NO ejecutar queries SQL destructivas sin backup**
   ```sql
   -- ‚ùå PROHIBIDO sin backup previo:
   DELETE FROM programa_users WHERE ...
   UPDATE programa_users SET estado = ...
   DROP TABLE ...
   ALTER TABLE ... DROP COLUMN ...
   ```

3. **NO modificar workflows en horarios de env√≠o**
   - Horarios cr√≠ticos: L/M/V 8:00-10:00 AM (UTC)
   - Si necesitas cambio urgente ‚Üí Desactivar workflow primero

4. **NO probar integraciones con datos reales de usuarios**
   - Usar siempre emails de prueba (albertvc10@gmail.com, test@local.com)
   - Stripe en modo test hasta validar completamente

5. **NO hacer deploy directo sin exportar workflow antes**
   - Siempre exportar versi√≥n actual como backup
   - Nombrar: `01-onboarding-backup-YYYY-MM-DD.json`

---

## ‚úÖ WORKFLOW OBLIGATORIO de Desarrollo

### Paso 1: Desarrollo Local
```bash
# 1. Iniciar entorno local (si no est√° corriendo)
cd ~/Documents/HV_n8n
docker-compose up -d

# Verificar que est√° corriendo
docker-compose ps
# Debes ver: n8n y n8n_postgres con status "Up"

# 2. Abrir n8n local
open http://localhost:5678

# 3. Crear/modificar workflows con prefijo [TEST-CV]
# Ejemplo: "[TEST-CV] 02-envio-programado"

# 4. Configurar workflow para usar schema camino_vital
# En nodos PostgreSQL:
# - Host: postgres
# - Database: n8n
# - Schema: camino_vital (o usar queries con camino_vital.tabla)

# 5. Probar con datos de prueba
# 6. Ejecutar manualmente m√∫ltiples veces
# 7. Verificar logs y resultados en DB local
```

### Paso 2: Validaci√≥n Local
```sql
-- Conectar a DB local (usando el contenedor existente)
docker exec -it n8n_postgres psql -U n8n -d n8n

-- Cambiar al schema de Camino Vital
SET search_path TO camino_vital;

-- Verificar datos creados/modificados
SELECT * FROM programa_users;
SELECT * FROM programa_envios;
SELECT * FROM programa_feedback;

-- O usar queries con schema expl√≠cito
SELECT * FROM camino_vital.programa_users;

-- Validar que la l√≥gica es correcta
```

### Paso 3: Exportar y Documentar
```bash
# 1. Exportar workflow desde local
# n8n ‚Üí Workflows ‚Üí [workflow] ‚Üí Download

# 2. Guardar en carpeta de workflows con versi√≥n
# Ejemplo: workflows/02-envio-programado-v2.json

# 3. Documentar cambios en git commit o archivo CHANGELOG
```

### Paso 4: Deploy a Producci√≥n
```bash
# 1. Conectar al servidor de producci√≥n
# (Solo desde hotspot m√≥vil)
ssh root@167.71.51.148

# 2. Hacer backup de DB (cambios importantes)
docker exec n8n-postgres-1 pg_dump -U n8n -d n8n > backup-$(date +%Y%m%d).sql

# 3. Ir a n8n producci√≥n
open https://n8n.habitos-vitales.com

# 4. DESACTIVAR workflow actual (toggle OFF)

# 5. Exportar workflow actual como backup
# Download ‚Üí Guardar como [nombre]-backup-YYYY-MM-DD.json

# 6. Importar nuevo workflow
# Option 1: Import from File ‚Üí Upload
# Option 2: Editar workflow existente (copiar/pegar nodos)

# 7. PROBAR ejecuci√≥n manual UNA VEZ
# Click "Execute Workflow"
# Verificar que funciona correctamente

# 8. Si OK ‚Üí ACTIVAR workflow (toggle ON)
# Si FALLA ‚Üí Revertir a versi√≥n anterior
```

### Paso 5: Monitoreo Post-Deploy
```bash
# 1. Verificar ejecuciones en n8n
# Executions ‚Üí Ver √∫ltimas 5 ejecuciones
# Buscar errores

# 2. Verificar logs de Docker (si es cr√≠tico)
ssh root@167.71.51.148
docker logs n8n-n8n-1 --tail 50 -f

# 3. Verificar DB
docker exec -it n8n-postgres-1 psql -U n8n -d n8n
SELECT * FROM programa_envios ORDER BY created_at DESC LIMIT 5;

# 4. Monitorear pr√≥ximo env√≠o programado
# Estar atento durante la primera ejecuci√≥n autom√°tica
```

---

## üóÑÔ∏è Gesti√≥n de Base de Datos

### Backups Obligatorios ANTES de:

- ‚úÖ Modificar schema (ALTER TABLE, DROP, etc.)
- ‚úÖ Actualizar datos masivamente (UPDATE con WHERE amplio)
- ‚úÖ Migrar usuarios (cambio de estado, nivel, etc.)
- ‚úÖ Deploy de cambios que tocan l√≥gica de DB

```bash
# Backup completo
ssh root@167.71.51.148
docker exec n8n-postgres-1 pg_dump -U n8n -d n8n > backup-$(date +%Y%m%d-%H%M).sql

# Backup solo schema
docker exec n8n-postgres-1 pg_dump -U n8n -d n8n --schema-only > schema-backup.sql

# Backup solo datos de tabla espec√≠fica
docker exec n8n-postgres-1 pg_dump -U n8n -d n8n -t programa_users > users-backup.sql

# Restaurar backup (si es necesario)
docker exec -i n8n-postgres-1 psql -U n8n -d n8n < backup-20250115.sql
```

### Queries Destructivas Seguras

```sql
-- ‚ùå MAL (sin WHERE):
UPDATE programa_users SET estado = 'activo';

-- ‚úÖ BIEN (con WHERE espec√≠fico):
UPDATE programa_users
SET estado = 'activo'
WHERE email = 'usuario@ejemplo.com';

-- ‚úÖ MEJOR (con RETURNING para verificar):
UPDATE programa_users
SET estado = 'activo'
WHERE email = 'usuario@ejemplo.com'
RETURNING id, email, nombre, estado;

-- ‚úÖ √ìPTIMO (con BEGIN/ROLLBACK para probar):
BEGIN;
UPDATE programa_users SET estado = 'activo' WHERE ...;
SELECT * FROM programa_users WHERE ...;  -- Verificar
-- Si OK:
COMMIT;
-- Si MAL:
ROLLBACK;
```

---

## üì¶ Estructura de Archivos del Proyecto

```
HV_n8n/                                  # Carpeta ra√≠z
‚îú‚îÄ‚îÄ docker-compose.yml                   # n8n + PostgreSQL local
‚îú‚îÄ‚îÄ .env                                 # Credenciales local
‚îú‚îÄ‚îÄ data/                                # Datos persistentes
‚îÇ   ‚îú‚îÄ‚îÄ postgres/                        # DB local (Instagram + Camino Vital)
‚îÇ   ‚îî‚îÄ‚îÄ n8n/                            # Workflows locales
‚îî‚îÄ‚îÄ programa-camino-vital/              # ‚Üê Proyecto Camino Vital
    ‚îú‚îÄ‚îÄ .clinerules                     # Este archivo (reglas de desarrollo)
    ‚îú‚îÄ‚îÄ setup-local.sh                  # üÜï Script de configuraci√≥n local
    ‚îú‚îÄ‚îÄ SETUP-LOCAL.md                  # üÜï Gu√≠a de setup paso a paso
    ‚îú‚îÄ‚îÄ docs/
    ‚îÇ   ‚îú‚îÄ‚îÄ README.md                   # Documentaci√≥n t√©cnica completa
    ‚îÇ   ‚îú‚îÄ‚îÄ ESTADO-ACTUAL.md            # Estado del deployment
    ‚îÇ   ‚îú‚îÄ‚îÄ RESUMEN-EJECUTIVO.md        # Visi√≥n de negocio
    ‚îÇ   ‚îú‚îÄ‚îÄ REGLAS-FLUJO-PROYECTO.md    # Flujos del usuario
    ‚îÇ   ‚îî‚îÄ‚îÄ STRIPE-SETUP.md             # Configuraci√≥n Stripe
    ‚îú‚îÄ‚îÄ database/
    ‚îÇ   ‚îú‚îÄ‚îÄ schema.sql                  # Schema principal
    ‚îÇ   ‚îú‚îÄ‚îÄ functions.sql               # Funciones SQL reutilizables (futuro)
    ‚îÇ   ‚îî‚îÄ‚îÄ seed-contenido.sql          # Datos de ejemplo
    ‚îú‚îÄ‚îÄ workflows/
    ‚îÇ   ‚îú‚îÄ‚îÄ 01-onboarding-v2.json       # ‚úÖ FUNCIONANDO
    ‚îÇ   ‚îú‚îÄ‚îÄ 02-envio-programado.json    # ‚è∏Ô∏è No probado completamente
    ‚îÇ   ‚îú‚îÄ‚îÄ 03-feedback.json            # ‚è∏Ô∏è No probado
    ‚îÇ   ‚îú‚îÄ‚îÄ 04-guardar-lead.json        # ‚úÖ FUNCIONANDO
    ‚îÇ   ‚îú‚îÄ‚îÄ 05-remarketing-leads.json   # ‚è∏Ô∏è No probado
    ‚îÇ   ‚îî‚îÄ‚îÄ backups/                    # Backups de workflows
    ‚îÇ       ‚îî‚îÄ‚îÄ [workflow]-YYYY-MM-DD.json
    ‚îî‚îÄ‚îÄ landing/
        ‚îú‚îÄ‚îÄ index.html                  # Landing principal
        ‚îú‚îÄ‚îÄ cuestionario.html           # Cuestionario multi-paso
        ‚îú‚îÄ‚îÄ resultados.html             # Resultados + checkout
        ‚îî‚îÄ‚îÄ gracias.html                # Post-pago
```

---

## üîß Comandos √ötiles para Claude

### Entorno Local (n8n existente para Instagram + Camino Vital)

```bash
# Verificar estado
cd ~/Documents/HV_n8n
docker-compose ps

# Iniciar (si est√° apagado)
docker-compose up -d

# Ver logs
docker-compose logs -f n8n

# Conectar a DB local
docker exec -it n8n_postgres psql -U n8n -d n8n

# Ver tablas de Camino Vital
docker exec -it n8n_postgres psql -U n8n -d n8n -c "\dt camino_vital.*"

# Detener (CUIDADO: tambi√©n detiene workflows de Instagram)
docker-compose stop

# Reiniciar solo n8n (sin tocar DB)
docker-compose restart n8n

# ‚ö†Ô∏è NUNCA ejecutar esto (borrar√≠a workflows de Instagram):
# docker-compose down -v
```

### Entorno Producci√≥n

```bash
# Conectar SSH (requiere hotspot m√≥vil)
ssh root@167.71.51.148

# Ver logs n8n
docker logs n8n-n8n-1 --tail 50 -f

# Ver logs PostgreSQL
docker logs n8n-postgres-1 --tail 50 -f

# Conectar a DB producci√≥n
docker exec -it n8n-postgres-1 psql -U n8n -d n8n

# Reiniciar servicios
cd /root/n8n
docker-compose restart

# Ver workflows activos
docker exec -it n8n-n8n-1 ls -la /home/node/.n8n/workflows/
```

---

## üß™ Testing

### Tests M√≠nimos Antes de Deploy

**Para workflows de env√≠o (02, 05):**
- [ ] Ejecutar manualmente en local con 3 usuarios de prueba
- [ ] Verificar que emails se "env√≠an" (mock) correctamente
- [ ] Verificar que se registra en `programa_envios`
- [ ] Verificar que `fecha_ultimo_envio` se actualiza
- [ ] Probar con usuario sin contenido disponible
- [ ] Probar con usuario ya recibi√≥ email hoy

**Para workflows de feedback (03):**
- [ ] Simular webhook con par√°metros: user_id, semana, respuesta
- [ ] Verificar que se guarda en `programa_feedback`
- [ ] Verificar que actualiza `semana_actual` correctamente
- [ ] Probar las 3 respuestas: facil, adecuado, dificil
- [ ] Verificar l√≥gica de progresi√≥n

**Para workflows de pago (01, 04):**
- [ ] Usar Stripe test mode SIEMPRE en local
- [ ] Verificar usuario pasa de 'lead' a 'activo'
- [ ] Verificar email de bienvenida se env√≠a
- [ ] Verificar movimiento en listas Brevo (mock)
- [ ] Probar con email que NO existe en DB
- [ ] Probar con email duplicado

---

## üìä Monitoreo de Salud del Sistema

### Queries de Diagn√≥stico

```sql
-- Usuarios activos vs leads
SELECT
  estado,
  COUNT(*) as cantidad
FROM programa_users
GROUP BY estado;

-- Env√≠os de hoy
SELECT
  u.email,
  u.nombre,
  e.created_at,
  e.estado
FROM programa_envios e
JOIN programa_users u ON e.user_id = u.id
WHERE e.created_at::date = CURRENT_DATE
ORDER BY e.created_at DESC;

-- Usuarios que NO recibieron email hoy (debiendo recibirlo)
SELECT
  email,
  nombre,
  nivel_actual,
  semana_actual,
  fecha_ultimo_envio
FROM programa_users
WHERE estado = 'activo'
  AND (fecha_ultimo_envio IS NULL OR fecha_ultimo_envio::date < CURRENT_DATE)
  AND EXTRACT(DOW FROM NOW()) IN (1,3,5);  -- L/M/V

-- Tasa de respuesta promedio
SELECT
  ROUND(AVG(tasa_respuesta), 2) as tasa_promedio,
  COUNT(*) as usuarios_activos
FROM programa_users
WHERE estado = 'activo';

-- Usuarios sin contenido disponible para su nivel/semana
SELECT
  u.email,
  u.nivel_actual,
  u.semana_actual,
  u.etapa
FROM programa_users u
LEFT JOIN programa_contenido c
  ON c.etapa = u.etapa
  AND c.nivel = u.nivel_actual
  AND c.semana = u.semana_actual
WHERE u.estado = 'activo'
  AND c.id IS NULL;
```

---

## üö® Plan de Contingencia

### Si rompes algo en producci√≥n:

**Nivel 1: Workflow no funciona**
```bash
# 1. DESACTIVAR workflow inmediatamente
# n8n ‚Üí Workflow ‚Üí Toggle OFF

# 2. Revisar √∫ltima ejecuci√≥n
# Executions ‚Üí Ver error

# 3. Revertir a versi√≥n anterior
# Import workflow backup m√°s reciente

# 4. Activar versi√≥n antigua
# Toggle ON

# 5. Investigar error en local
```

**Nivel 2: Base de datos corrupta**
```bash
# 1. Detener n8n para evitar m√°s escrituras
docker stop n8n-n8n-1

# 2. Restaurar backup m√°s reciente
docker exec -i n8n-postgres-1 psql -U n8n -d n8n < backup-latest.sql

# 3. Verificar datos
docker exec -it n8n-postgres-1 psql -U n8n -d n8n
SELECT COUNT(*) FROM programa_users;

# 4. Reiniciar n8n
docker start n8n-n8n-1
```

**Nivel 3: Servidor ca√≠do**
```bash
# 1. Verificar uptime
ssh root@167.71.51.148
uptime

# 2. Reiniciar Docker
docker-compose restart

# 3. Si persiste, reiniciar servidor
reboot

# 4. Verificar que servicios vuelven
# Esperar 2-3 minutos
docker ps

# 5. Comunicar a usuarios (si ca√≠da >30 min)
# Email manual desde Brevo
```

---

## üìù Reglas de Comunicaci√≥n con Usuarios

### Cu√°ndo avisar a usuarios:

- ‚úÖ Ca√≠da del sistema >1 hora
- ‚úÖ Error que afect√≥ env√≠o programado (perdieron email del d√≠a)
- ‚úÖ Cambio significativo en el sistema (nueva funcionalidad)
- ‚úÖ Migraci√≥n que requiere acci√≥n del usuario

### Cu√°ndo NO avisar:

- ‚ùå Bugs menores corregidos en <30 min
- ‚ùå Mejoras internas que no afectan experiencia
- ‚ùå Testing en local
- ‚ùå Updates de infraestructura transparentes

### Plantilla de comunicaci√≥n de incidencia:

```
Asunto: [Resuelto] Peque√±o problema t√©cnico en Camino Vital

Hola {nombre},

Te escribo para contarte que hoy entre las X:XX y X:XX hubo un
problema t√©cnico que [descripci√≥n del impacto].

‚úÖ Ya est√° resuelto y todo funciona con normalidad.

[Si perdieron un email:]
Como compensaci√≥n, recibir√°s tu pr√≥ximo email con contenido extra.

Gracias por tu paciencia,
Albert - Equipo Camino Vital
```

---

## üéØ Criterios de √âxito

### M√©tricas que NUNCA deben bajar:

- **Uptime del sistema:** >99% mensual
- **Tasa de entrega de emails:** >95% (emails enviados vs programados)
- **Tasa de error en workflows:** <5%

### Alertas que debes configurar (futuro):

- [ ] Email si workflow falla 2+ veces consecutivas
- [ ] Email si >10 usuarios no reciben email programado
- [ ] Email si DB no responde por >5 minutos
- [ ] Monitoreo de uptime con UptimeRobot

---

## üîê Seguridad

### Credenciales y Secretos

**NUNCA hacer:**
- ‚ùå Commitear `.env` a git
- ‚ùå Poner API keys en c√≥digo
- ‚ùå Compartir credenciales de producci√≥n
- ‚ùå Usar mismas passwords en local y producci√≥n

**SIEMPRE hacer:**
- ‚úÖ Usar variables de entorno
- ‚úÖ Rotar API keys cada 3-6 meses
- ‚úÖ Passwords diferentes para local vs producci√≥n
- ‚úÖ Backup de .env en lugar seguro (1Password, etc.)

### Ubicaci√≥n de credenciales:

```
PRODUCCI√ìN:
- .env en servidor: /root/n8n/.env
- n8n credentials: Encriptadas en DB PostgreSQL
- Stripe keys: Dashboard Stripe (live mode)
- Brevo API: xkeysib-2cd29536... (documentado en ESTADO-ACTUAL.md)

LOCAL:
- .env en laptop: ~/Documents/HV_n8n/local-dev/.env
- Usar API keys de TEST/STAGING
- Stripe: Test mode keys
```

---

## ü§ñ Instrucciones para Claude Code

Cuando trabajes en este proyecto:

1. **SIEMPRE pregunta antes de:**
   - Modificar workflows en producci√≥n
   - Ejecutar queries DELETE o DROP
   - Hacer cambios en schema de DB
   - Deploy de cambios significativos

2. **SIEMPRE asume:**
   - Hay usuarios reales usando el sistema
   - Un error puede afectar a cientos de personas
   - Necesitas probar en local primero

3. **SIEMPRE prioriza:**
   - No romper funcionalidad existente
   - Mantener servicio funcionando 24/7
   - Simplicidad sobre complejidad
   - Documentar cambios importantes

4. **Si necesitas hacer cambios urgentes en producci√≥n:**
   - Avisar al usuario (Albert) claramente
   - Explicar riesgos
   - Pedir confirmaci√≥n expl√≠cita
   - Hacer backup antes

5. **Cuando sugieras soluciones:**
   - Considera que hay miles de seguidores potenciales
   - El sistema debe escalar a 100-1000 usuarios
   - Prioriza estabilidad sobre features nuevas
   - Piensa en mantenibilidad a largo plazo

---

## üìû Contactos de Emergencia

**Desarrollador:** Albert Villanueva (albertvc10@gmail.com)
**Servidor:** Digital Ocean - 167.71.51.148
**Proveedor Email:** Brevo (app.brevo.com)
**Procesador Pagos:** Stripe (dashboard.stripe.com)
**Dominio:** Namecheap (habitos-vitales.com)

---

**√öltima actualizaci√≥n:** 2025-01-15
**Versi√≥n:** 1.0.0
**Mantenido por:** Albert Villanueva
