{
  "name": "Camino Vital - 06 Checkpoint Dominical",
  "active": true,
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [{"field": "cronExpression", "expression": "0 18 * * 0"}]
        }
      },
      "id": "cron-domingo",
      "name": "Cron: Cada Domingo 18:00",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [240, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Obtener usuarios activos que completaron todas las sesiones de la semana\nSELECT\n  id,\n  email,\n  nombre,\n  etapa,\n  nivel_actual,\n  semana_actual,\n  sesiones_objetivo_semana,\n  sesiones_completadas_semana,\n  semanas_consecutivas_completas,\n  intensidad_nivel\nFROM programa_users\nWHERE estado = 'activo'\n  AND sesiones_completadas_semana >= sesiones_objetivo_semana\n  AND sesiones_objetivo_semana > 0\n  AND semana_actual >= 1\n  AND semana_actual <= 12\nORDER BY id;",
        "options": {}
      },
      "id": "obtener-usuarios-activos",
      "name": "Obtener Usuarios Activos",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [460, 300],
      "credentials": {
        "postgres": {
          "id": "nLcUOvLreXurFbBs",
          "name": "PostgreSQL Camino Vital Local"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "loose"},
          "conditions": [
            {
              "id": "semana-12",
              "leftValue": "={{ $json.semana_actual }}",
              "rightValue": 12,
              "operator": {"type": "number", "operation": "equals"}
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-programa-completado",
      "name": "IF: Â¿Semana 12 (Programa completado)?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT html_template FROM email_templates WHERE nombre = 'programa_completado' AND version = 1;",
        "options": {}
      },
      "id": "obtener-template-completado",
      "name": "Obtener Template Programa Completado",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [900, 200],
      "credentials": {
        "postgres": {
          "id": "nLcUOvLreXurFbBs",
          "name": "PostgreSQL Camino Vital Local"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Marcar programa como completado\nUPDATE programa_users\nSET estado = 'completado', updated_at = NOW()\nWHERE id = {{ $node['Obtener Usuarios Activos'].json.id }}\nRETURNING *;",
        "options": {}
      },
      "id": "marcar-completado",
      "name": "Marcar Programa Completado",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [1120, 200],
      "credentials": {
        "postgres": {
          "id": "nLcUOvLreXurFbBs",
          "name": "PostgreSQL Camino Vital Local"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Preparar email de programa completado\n\nfunction replaceVariables(template, variables) {\n  let result = template;\n  for (const [key, value] of Object.entries(variables)) {\n    const safeValue = String(value ?? '');\n    const regex = new RegExp(`\\\\{\\\\{${key}\\\\}\\\\}`, 'g');\n    result = result.replace(regex, safeValue);\n  }\n  return result;\n}\n\nconst usuario = $node['Marcar Programa Completado'].json;\nconst template = $node['Obtener Template Programa Completado'].json.html_template;\n\nconsole.log('ðŸ† Preparando email de programa completado para:', usuario.email);\n\nconst variables = {\n  nombre: usuario.nombre,\n  nivel_actual: usuario.nivel_actual,\n  intensidad: usuario.intensidad_nivel\n};\n\nconst emailHTML = replaceVariables(template, variables);\n\nreturn {\n  json: {\n    user_id: usuario.id,\n    user_email: usuario.email,\n    user_nombre: usuario.nombre,\n    email_html: emailHTML,\n    asunto: 'ðŸ† Â¡Felicidades! Has completado Base Vital'\n  }\n};"
      },
      "id": "preparar-email-completado",
      "name": "Preparar Email Programa Completado",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.WEBHOOK_URL }}/webhook/util/enviar-email",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {"timeout": 30000}
      },
      "id": "enviar-email-completado",
      "name": "Enviar Email Completado (UTIL)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1560, 200]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Obtener template de checkpoint semanal\nSELECT * FROM get_email_template('checkpoint_semanal');",
        "options": {}
      },
      "id": "obtener-template-checkpoint",
      "name": "Obtener Template Checkpoint",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [900, 400],
      "credentials": {
        "postgres": {
          "id": "nLcUOvLreXurFbBs",
          "name": "PostgreSQL Camino Vital Local"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Preparar email de checkpoint semanal con botones de feedback\n\nfunction replaceVariables(template, variables) {\n  let result = template;\n  for (const [key, value] of Object.entries(variables)) {\n    const safeValue = String(value ?? '');\n    const regex = new RegExp(`\\\\{\\\\{${key}\\\\}\\\\}`, 'g');\n    result = result.replace(regex, safeValue);\n  }\n  return result;\n}\n\nconst usuario = $node['Obtener Usuarios Activos'].json;\nconst template = $json.html_template;\n\nconsole.log('ðŸ“§ Preparando checkpoint para:', usuario.email);\n\nconst variables = {\n  nombre: usuario.nombre,\n  semana_actual: usuario.semana_actual,\n  semana_siguiente: usuario.semana_actual + 1,\n  sesiones_completadas: usuario.sesiones_completadas_semana,\n  sesiones_objetivo: usuario.sesiones_objetivo_semana,\n  semanas_consecutivas: usuario.semanas_consecutivas_completas || 0,\n  nivel_actual: usuario.nivel_actual,\n  intensidad: usuario.intensidad_nivel,\n  user_id: usuario.id,\n  webhook_url: process.env.WEBHOOK_URL || 'http://localhost:5678'\n};\n\nconst emailHTML = replaceVariables(template, variables);\n\nreturn {\n  json: {\n    user_id: usuario.id,\n    user_email: usuario.email,\n    user_nombre: usuario.nombre,\n    semana: usuario.semana_actual,\n    email_html: emailHTML,\n    asunto: `ðŸŽ‰ Â¡Semana ${usuario.semana_actual} completada! - Â¿CÃ³mo te fue?`\n  }\n};"
      },
      "id": "preparar-email-checkpoint",
      "name": "Preparar Email Checkpoint",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.WEBHOOK_URL }}/webhook/util/enviar-email",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {"timeout": 30000}
      },
      "id": "enviar-checkpoint",
      "name": "Enviar Checkpoint (UTIL)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1340, 400]
    }
  ],
  "connections": {
    "Cron: Cada Domingo 18:00": {
      "main": [[{"node": "Obtener Usuarios Activos", "type": "main", "index": 0}]]
    },
    "Obtener Usuarios Activos": {
      "main": [[{"node": "IF: Â¿Semana 12 (Programa completado)?", "type": "main", "index": 0}]]
    },
    "IF: Â¿Semana 12 (Programa completado)?": {
      "main": [
        [{"node": "Obtener Template Programa Completado", "type": "main", "index": 0}],
        [{"node": "Obtener Template Checkpoint", "type": "main", "index": 0}]
      ]
    },
    "Obtener Template Programa Completado": {
      "main": [[{"node": "Marcar Programa Completado", "type": "main", "index": 0}]]
    },
    "Marcar Programa Completado": {
      "main": [[{"node": "Preparar Email Programa Completado", "type": "main", "index": 0}]]
    },
    "Preparar Email Programa Completado": {
      "main": [[{"node": "Enviar Email Completado (UTIL)", "type": "main", "index": 0}]]
    },
    "Obtener Template Checkpoint": {
      "main": [[{"node": "Preparar Email Checkpoint", "type": "main", "index": 0}]]
    },
    "Preparar Email Checkpoint": {
      "main": [[{"node": "Enviar Checkpoint (UTIL)", "type": "main", "index": 0}]]
    }
  },
  "settings": {"executionOrder": "v1"},
  "pinData": {},
  "versionId": "v3-programa-completado"
}
