{
  "name": "Camino Vital - 00 Activar Usuarios Programados",
  "active": false,
  "nodes": [
    {
      "parameters": {},
      "id": "manual-trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [240, 300],
      "notes": "Ejecutar manualmente el 1 de marzo para activar usuarios de preventa"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT jsonb_object_agg(key, value) as config FROM config WHERE key IN ('WEBHOOK_URL', 'BREVO_API_KEY', 'SENDER_EMAIL', 'SENDER_NAME');",
        "options": {}
      },
      "id": "obtener-config",
      "name": "Obtener Config",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [460, 300],
      "credentials": {
        "postgres": {
          "id": "nLcUOvLreXurFbBs",
          "name": "PostgreSQL local"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT html_template FROM email_templates WHERE nombre = 'email_bienvenida' AND activo = true;",
        "options": {}
      },
      "id": "obtener-template-bienvenida",
      "name": "Obtener Template Bienvenida",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [680, 300],
      "credentials": {
        "postgres": {
          "id": "nLcUOvLreXurFbBs",
          "name": "PostgreSQL local"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Buscar usuarios pendientes de activar (preventa)\n-- FILTRO TEMPORAL: Solo emails con '+' para testing\nSELECT \n  id, \n  email, \n  nombre, \n  nivel_actual,\n  etapa,\n  perfil_inicial\nFROM programa_users\nWHERE estado = 'pagado_esperando_inicio'\nAND email LIKE '%+%';",
        "options": {}
      },
      "id": "buscar-usuarios-pendientes",
      "name": "Buscar Usuarios Pendientes",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [900, 300],
      "credentials": {
        "postgres": {
          "id": "nLcUOvLreXurFbBs",
          "name": "PostgreSQL local"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "hay-usuarios",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "number",
                "operation": "exists"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-hay-usuarios",
      "name": "IF Â¿Hay usuarios?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "jsCode": "// Log cuando no hay usuarios para activar\nconsole.log('â„¹ï¸ No hay usuarios pendientes de activar');\n\nreturn {\n  json: {\n    message: 'No hay usuarios pendientes de activar',\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "log-sin-usuarios",
      "name": "Log Sin Usuarios",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Activar usuario: cambiar estado a 'activo' y establecer fecha_inicio\nUPDATE programa_users\nSET \n  estado = 'activo',\n  fecha_inicio = CURRENT_TIMESTAMP,\n  updated_at = CURRENT_TIMESTAMP\nWHERE id = {{ $json.id }}\nRETURNING *;",
        "options": {}
      },
      "id": "activar-usuario-db",
      "name": "Activar Usuario en DB",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [1340, 200],
      "credentials": {
        "postgres": {
          "id": "nLcUOvLreXurFbBs",
          "name": "PostgreSQL local"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Renderizar template para TODOS los usuarios del array\nconst items = $input.all();\nconst template = $('Obtener Template Bienvenida').first().json.html_template;\n\n// Obtener config desde BD (agregado en una sola fila JSON)\nconst config = $('Obtener Config').first().json.config;\n\nconst baseUrl = config.WEBHOOK_URL || 'http://localhost:5678';\nconst brevoApiKey = config.BREVO_API_KEY;\nconst senderEmail = config.SENDER_EMAIL || 'hola@habitos-vitales.com';\nconst senderName = config.SENDER_NAME || 'Camino Vital';\n\nconsole.log('ðŸ“§ Procesando', items.length, 'usuarios');\n\n// Procesar cada usuario\nconst results = items.map(item => {\n  const usuario = item.json;\n  const nivel = usuario.nivel_actual === 'iniciacion' ? 'IniciaciÃ³n' : 'Intermedio';\n  \n  console.log('  â†’ Renderizando email para:', usuario.email);\n  \n  const html = template\n    .replace(/\\{\\{nombre\\}\\}/g, usuario.nombre || '')\n    .replace(/\\{\\{nivel\\}\\}/g, nivel)\n    .replace(/\\{\\{user_id\\}\\}/g, usuario.id)\n    .replace(/\\{\\{base_url\\}\\}/g, baseUrl);\n  \n  return {\n    json: {\n      html_renderizado: html,\n      email: usuario.email,\n      nombre: usuario.nombre,\n      user_id: usuario.id,\n      brevo_api_key: brevoApiKey,\n      sender_email: senderEmail,\n      sender_name: senderName\n    }\n  };\n});\n\nreturn results;"
      },
      "id": "renderizar-template",
      "name": "Renderizar Template",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1560, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.brevo.com/v3/smtp/email",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api-key",
              "value": "={{ $json.brevo_api_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"sender\": {\n    \"name\": \"{{ $json.sender_name }}\",\n    \"email\": \"{{ $json.sender_email }}\"\n  },\n  \"to\": [\n    {\n      \"email\": \"{{ $json.email }}\",\n      \"name\": \"{{ $json.nombre }}\"\n    }\n  ],\n  \"subject\": \"âœ¨ Â¡Tu Camino Vital empieza hoy! Elige cuÃ¡ntas sesiones hacer\",\n  \"htmlContent\": {{ JSON.stringify($json.html_renderizado) }}\n}",
        "options": {}
      },
      "id": "enviar-email-bienvenida",
      "name": "Enviar Email Bienvenida",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1780, 200]
    },
    {
      "parameters": {
        "jsCode": "// Log usuario activado exitosamente\nconst email = $json.to?.[0]?.email || $json.email || 'desconocido';\n\nconsole.log('âœ… Email de bienvenida enviado a:', email);\n\nreturn {\n  json: {\n    success: true,\n    email: email,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "log-exito",
      "name": "Log Ã‰xito",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2000, 200]
    }
  ],
  "connections": {
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Obtener Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Config": {
      "main": [
        [
          {
            "node": "Obtener Template Bienvenida",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Template Bienvenida": {
      "main": [
        [
          {
            "node": "Buscar Usuarios Pendientes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Usuarios Pendientes": {
      "main": [
        [
          {
            "node": "IF Â¿Hay usuarios?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Â¿Hay usuarios?": {
      "main": [
        [
          {
            "node": "Activar Usuario en DB",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Sin Usuarios",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Activar Usuario en DB": {
      "main": [
        [
          {
            "node": "Renderizar Template",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Renderizar Template": {
      "main": [
        [
          {
            "node": "Enviar Email Bienvenida",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Email Bienvenida": {
      "main": [
        [
          {
            "node": "Log Ã‰xito",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "name": "Camino Vital",
      "id": "cv-1"
    },
    {
      "name": "Preventa",
      "id": "cv-preventa"
    }
  ],
  "meta": {
    "instanceId": "local"
  },
  "pinData": {},
  "versionId": "6"
}
